#!/bin/sh
##
## PM TrueCrypt mounting and dismounting script. 
## Version: 2.2
## Author: Philipp Meisberger <team@pm-codeworks.de>#
## 
## using: PM [action] [options] 
## action: --mount|--dismount|--auto
## options (optional): --silent|--non-interactive
## 
## action
## --mount:             Mount a decrypted TrueCrypt volume. 
## --dismount:          Dismount a Truecrypt volume. 
## --auto:              Either mount a Truecrypt volume if it is dismounted or dismount a TrueCrypt volume if it is mounted.
##
## options
## --silent:            Suppress error if keyfile was not found.
## --non-interactive:   Suppress gtk messages.
##

# ID for device being mounted
DEVICE=/dev/disk/by-id/ata-SAMSUNG_SSD_830_Series_S0Z4NEAC936383-part4

# Path to directory where device shall be mounted
MOUNTPOINT=/media/PM

# Subfolder in mounted device
SUBFOLDER=/media/PM/Keys

# Keyfile for device decryption
KEYFILE=/media/SDCard/Key

# Path to device containing keyfile 
TOKEN=/media/SDCard

## --- END OF CONFIGURATION ---

Error() {

	if ( test $INTERACTIVE = true ); then
		zenity --error --text="$1" 
	else
		echo "$1"
	fi
}

Info() {

	if ( test $INTERACTIVE = true ); then
		zenity --info --text="$1"
	else
		echo "$1"
	fi
}

Mounted(){
  
	if ( test -d $SUBFOLDER ); then
		return true 
	else
		return false
	fi
}

Mount() {

	if ( ! mount -l | grep "$TOKEN" > /dev/null ); then
		mount $TOKEN && sleep 2
	fi

	if ( test -f $KEYFILE ); then
		echo "Mounting..."      
		truecrypt --text --non-interactive $DEVICE $MOUNTPOINT --keyfiles=$KEYFILE

		if ( test $? = false ); then
			Error "Error while mounting!"
			return 1
		else 
			Info "Successfully mounted!"
			return 0
		fi
	else
		if ( test "$2" != "--silent" ); then
			Error "Keyfile not found!"
			return 1   
		fi
	fi
}
  
Dismount() {
  
	echo "Dismounting..."
	truecrypt --text --non-interactive --dismount $DEVICE 

	if ( test "$?" = "1" ); then
		Error "Error while dismounting!"		
		return 1
	else 
		Info "Successfully dismounted!"
		umount $TOKEN && sleep 2
		return 0
	fi  
}

# Main:

if ( test "$2" = "--non-interactive" || test "$3" = "--non-interactive" ); then
	INTERACTIVE=false
else
	INTERACTIVE=true
fi
	
case "$1" in
	--dismount) 
		Dismount
		;;
	
	--mount)
		Mount
		;;
		
	--auto)
		if ( Mounted ); then
			Dismount
		else
			Mount
		fi
		;;
		
	*)
		echo "Invalid parameters!"
		echo ""	
		echo "Using: $0 [action] [options]"
		echo "action: --mount|--dismount|--auto"
		echo "options (optional): --silent|--non-interactive"
		echo ""
		echo "action"
		echo "--mount           Mount a decrypted TrueCrypt volume."
		echo "--dismount        Dismount a Truecrypt volume."
		echo "--auto            Either mount a Truecrypt volume if it is dismounted or dismount a TrueCrypt volume if it is mounted."
		echo ""
		echo "options"
		echo "--silent          Suppress error if keyfile was not found."
		echo "--non-interactive Suppress gtk messages."
		echo ""
esac
	
exit 0
